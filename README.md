# zp-memory-pool
ä½¿ç”¨c++å®ç°memory poolï¼Œä¾›å­¦ä¹ ç»ƒä¹ ä½¿ç”¨
## é¡¹ç›®å¼€å‘ç¯å¢ƒæ­å»º
[å‚è€ƒè¯¥é¡¹ç›®çš„ç°ä»£C++å¼€å‘ç¯å¢ƒ](https://github.com/rutura/cpp23m)

#   é¡¹ç›®åˆ†æ
## 1.ä¸ºå•¥å­è¦memory poolï¼Ÿ
```C++
// ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜
for(int i = 0; i < 10000; ++i) {
    MyObject* obj = new MyObject();  // æ¯æ¬¡éƒ½è¦å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜
    // ... ä½¿ç”¨å¯¹è±¡
    delete obj;                      // æ¯æ¬¡éƒ½è¦å½’è¿˜ç»™æ“ä½œç³»ç»Ÿ
}
```
**questionï¼š**
+ **å†…å­˜å¼€é”€å¤§**ï¼šæ¯æ¬¡ new/delete éƒ½è¦ç³»ç»Ÿè°ƒç”¨
+ **å†…å­˜ç¢ç‰‡**ï¼š é¢‘ç¹åˆ†é…é‡Šæ”¾å¯¼è‡´å†…å­˜ç¢ç‰‡åŒ–ï¼ˆå†…ç¢ç‰‡ï¼Œä¸€åˆ†é…å—å†…æœªè¢«å®é™…ä½¿ç”¨çš„éƒ¨åˆ†ï¼›å¤–ç¢ç‰‡ï¼Œç³»ç»Ÿä¸­æœ‰è¶³å¤Ÿçš„ç©ºé—²å†…å­˜ï¼Œä½†æ˜¯è¿™äº›ç©ºé—²ä¸è¿ç»­ï¼Œæ— æ³•æ»¡è¶³ä¸€ä¸ªè¾ƒå¤§çš„åˆ†é…è¯·æ±‚ï¼‰
+ **ä¸ç¡®å®šæ€§**ï¼š åˆ†é…æ—¶é—´ä¸å¯é¢„æµ‹ 

å†…å­˜æ± å°±æ˜¯é€šè¿‡ä¸é¢„å…ˆåˆ†é…ï¼ˆnewï¼‰ä¸€å¤§å—å†…å­˜ä½œä¸ºpoolï¼Œç„¶åæ–°å¯¹è±¡å°±ä½¿ç”¨poolä¸­çš„å†…å­˜ã€‚
```
å†…å­˜æ± ä¸­çš„ Block é“¾è¡¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Memory Pool                          â”‚
â”‚                   (slot_size=64)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Block 3 (æœ€æ–°åˆ†é…çš„)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚Header â”‚ Slot1   â”‚ Slot2   â”‚ Slot3   â”‚  ...    â”‚      â”‚
â”‚  â”‚next=B2â”‚ (64B)   â”‚ (64B)   â”‚ (64B)   â”‚         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Block 2                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚Header â”‚ Slot1   â”‚ Slot2   â”‚ Slot3   â”‚  ...    â”‚      â”‚
â”‚  â”‚next=B1â”‚ (64B)   â”‚ (64B)   â”‚ (64B)   â”‚         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Block 1 (æœ€åˆåˆ†é…çš„)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚Header â”‚ Slot1   â”‚ Slot2   â”‚ Slot3   â”‚  ...    â”‚      â”‚
â”‚  â”‚next=  â”‚ (64B)   â”‚ (64B)   â”‚ (64B)   â”‚         â”‚      â”‚
â”‚  â”‚NULL   â”‚         â”‚         â”‚         â”‚         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2.æ ¸å¿ƒdatastructure
### 2.1 Slot
```C++
struct Slot{
    Slot* next;/// pointer to the next free slot
}
```
```bash
    å†…å­˜å¸ƒå±€ç¤ºæ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Slot 1    â”‚   Slot 2    â”‚   Slot 3    â”‚
â”‚ next = &S2  â”‚ next = &S3  â”‚ next = NULL â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“             â†“             â†“
   free_list     (ç©ºé—²é“¾è¡¨)
```
**ä¸ºå•¥å­è¿™ä¹ˆè®¾è®¡ï¼Ÿ**
+ é›¶é¢å¤–å¼€é”€ï¼šåˆ©ç”¨æœªåˆ†é…çš„å†…å­˜ç©ºé—´å­˜å‚¨é“¾è¡¨æŒ‡é’ˆ
+ **Oï¼ˆ1ï¼‰åˆ†é…** ï¼šç›´æ¥ä»é“¾è¡¨å¤´å–å‡ºå³å¯
+ **Oï¼ˆ1ï¼‰é‡Šæ”¾**ï¼š ç›´æ¥æ’å…¥é“¾è¡¨å¤´å³å¯

### 2.2 å†…å­˜å—ç®¡ç†
```C++
private:
    size_t          block_size_;            // æ¯ä¸ªå¤§å—çš„å¤§å°(å¦‚4KB)
    size_t          slot_size_;             // æ¯ä¸ªæ§½çš„å¤§å°(å¦‚64å­—èŠ‚)
    Slot*           first_block_;           // æŒ‡å‘ç¬¬ä¸€ä¸ªå†…å­˜å—
    Slot*           current_slot_;          // å½“å‰å¯ç”¨æ§½çš„ä½ç½®
    Slot*           free_list_;             // å·²é‡Šæ”¾ä½†å¯é‡ç”¨çš„æ§½é“¾è¡¨
    Slot*           last_slot_;             // å½“å‰å—çš„æœ€åä¸€ä¸ªæ§½
```
```bash
Memory Block (4096 bytes):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Block Headerâ”‚              Slots Area                     â”‚
â”‚(next ptr)  â”‚  [Slot1][Slot2][Slot3]...[SlotN]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†‘                              â†‘
        current_slot                   last_slot
```

## 3. æ ¸å¿ƒç®—æ³•
### 3.1 å†…å­˜åˆ†é…

```c++
void* MemoryPool::Allocate(){
    // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šé‡ç”¨å·²é‡Šæ”¾çš„å†…å­˜
    if(free_list_ != nullptr){
        {
            std::lock_guard<std::mutex> lock(mutex_for_free_list_);
            if(free_list_ != nullptr){  // åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼
                Slot* temp = free_list_;
                free_list_ = free_list_->next;  // é“¾è¡¨å¤´å‡ºé˜Ÿ
                return temp;
            }
        }
    }

    // ç¬¬äºŒä¼˜å…ˆçº§ï¼šä»å½“å‰å—åˆ†é…æ–°æ§½
    Slot* temp;
    {
        std::lock_guard<std::mutex> lock(mutex_for_block_);
        if(current_slot_ == nullptr || current_slot_ > last_slot_){
            AllocateNewBlock();  // å½“å‰å—ç”¨å®Œï¼Œåˆ†é…æ–°å—
        }

        temp = current_slot_;
        // æŒ‡é’ˆç®—æœ¯ï¼šç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæ§½ä½ç½®
        current_slot_ = reinterpret_cast<Slot*>(
            reinterpret_cast<char*>(current_slot_) + slot_size_
        );
    }
    return temp;
}
```
+ **ä¼˜å…ˆé‡ç”¨**ï¼š å…ˆæ£€æŸ¥å·²é‡Šæ”¾çš„å†…å­˜ï¼Œå‡å°‘æµªè´¹
+ **åŒé‡æ£€æŸ¥é”**ï¼š ä¿è¯çº¿ç¨‹å®‰å…¨çš„åŒæ—¶æé«˜æ€§èƒ½
+ **æŒ‡é’ˆç®—æœ¯** ï¼š ç²¾ç¡®è®¡ç®—ä¸‹ä¸€ä¸ªæ§½çš„ä½ç½®   
### 3.2æ–°å—åˆ†é…ç®—æ³•
```C++
void MemoryPool::AllocateNewBlock()
{
    // åˆ†é…ä¸€å¤§å—åŸå§‹å†…å­˜
    void* new_block = operator new(block_size_);
    
    // å»ºç«‹å—é“¾è¡¨ï¼ˆç”¨äºææ„æ—¶é‡Šæ”¾ï¼‰
    reinterpret_cast<Slot*>(new_block)->next = first_block_;
    first_block_ = reinterpret_cast<Slot*>(new_block);

    // è®¡ç®—å¯ç”¨å†…å­˜åŒºåŸŸ
    char* body = reinterpret_cast<char*>(new_block) + sizeof(Slot*);
    size_t padding_size = PadPointer(body, slot_size_);
    
    // è®¾ç½®å½“å‰æ§½å’Œæœ€åæ§½çš„ä½ç½®
    current_slot_ = reinterpret_cast<Slot*>(body + padding_size);
    char* block_end = reinterpret_cast<char*>(new_block) + block_size_;
    last_slot_ = reinterpret_cast<Slot*>(block_end - slot_size_);
}
```

1. **å—é“¾è¡¨ç®¡ç†**ï¼šæ¯ä¸ªblockçš„å¼€å¤´å­˜å‚¨æŒ‡å‘ä¸‹ä¸€ä¸ªblockçš„æŒ‡é’ˆ
2. **å†…å­˜å¯¹é½**ï¼š ç¡®ä¿æ§½çš„èµ·å§‹åœ°å€æ»¡è¶³å¯¹é½è¦æ±‚
3. **è¾¹ç•Œè®¡ç®—**ï¼š ç²¾ç¡®è®¡ç®—æœ€åä¸€ä¸ªæœ‰æ•ˆslotçš„ä½ç½®ã€‚  
### 3.3 å†…å­˜å¯¹é½ç®—æ³•
```cPP
size_t MemoryPool::PadPointer(char* p, size_t align)
{
    // è®¡ç®—éœ€è¦å¡«å……å¤šå°‘å­—èŠ‚æ¥è¾¾åˆ°å¯¹é½
    return (align - reinterpret_cast<size_t>(p)) % align;
}
```
```h
// ä¸å¯¹é½çš„å†…å­˜è®¿é—®ï¼ˆå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜æˆ–å´©æºƒï¼‰
struct Data {
    double value;  // éœ€è¦8å­—èŠ‚å¯¹é½
};

// å¦‚æœæŒ‡é’ˆä¸æ˜¯8çš„å€æ•°ï¼Œè®¿é—®å¯èƒ½å¾ˆæ…¢æˆ–å‡ºé”™
```
## 4.é«˜çº§è®¾è®¡ï¼šHashBucket ç³»ç»Ÿ
### 4.1 å¤šæ± ç®¡ç†

```CPP
class HashBucket {
    static MemoryPool& getMemoryPool(int index){
        static MemoryPool pools[MEMORY_POOL_NUM];  // 64ä¸ªä¸åŒå¤§å°çš„æ± 
        return pools[index];
    }
    
    static void* useMemory(size_t size){
        if(size > MAX_SLOT_SIZE)
            return operator new(size);  // è¶…å¤§å†…å­˜ç”¨æ ‡å‡†åˆ†é…

        // æ ¹æ®å¤§å°é€‰æ‹©åˆé€‚çš„æ± ï¼š8,16,24,32...512å­—èŠ‚
        return getMemoryPool(((size + 7) / SLOT_BASE_SIZE) - 1).Allocate();
    }
};
```

```bash
Pool 0: 8å­—èŠ‚æ§½   -> é€‚åˆå°å¯¹è±¡
Pool 1: 16å­—èŠ‚æ§½  -> é€‚åˆç¨å¤§å¯¹è±¡  
Pool 2: 24å­—èŠ‚æ§½  -> ...
...
Pool 63: 512å­—èŠ‚æ§½ -> é€‚åˆå¤§å¯¹è±¡
> 512å­—èŠ‚: ä½¿ç”¨æ ‡å‡† new/delete
```

### 4.2 æ¨¡æ¿æ¥å£è®¾è®¡
```C++
template<typename T, typename... Args>
T* newElement(Args&&... args){
    T* p = nullptr;
    // æ ¹æ®ç±»å‹å¤§å°è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ± 
    if((p = reinterpret_cast<T*>(HashBucket::useMemory(sizeof(T)))) != nullptr){
        // placement new: åœ¨å·²åˆ†é…å†…å­˜ä¸Šæ„é€ å¯¹è±¡
        new(p) T(std::forward<Args>(args)...);
    }
    return p;
}
```
**why use placement new?**
```CPP
// ä¼ ç»Ÿæ–¹å¼ï¼šåˆ†é…+æ„é€ ä¸€ä½“åŒ–
MyClass* obj = new MyClass(arg1, arg2);

// å†…å­˜æ± æ–¹å¼ï¼šåˆ†ç¦»åˆ†é…å’Œæ„é€ 
void* memory = pool.Allocate();           // åªåˆ†é…å†…å­˜
MyClass* obj = new(memory) MyClass(arg1, arg2);  // åœ¨æŒ‡å®šä½ç½®æ„é€ 
```

## 5. çº¿ç¨‹å®‰å…¨è®¾è®¡
### 5.1 åŒé”ç­–ç•¥
```CPP
std::mutex mutex_for_free_list_;   // ä¿æŠ¤ç©ºé—²é“¾è¡¨
std::mutex mutex_for_block_;       // ä¿æŠ¤å—åˆ†é…
```
**ä¸ºå•¥å­ç”¨ä¸¤ä¸ªğŸ”’ï¼Ÿ**
1. å‡å°‘é”ç«äº‰ï¼š ä¸åŒæ“ä½œç”¨ä¸åŒé”
2. æé«˜å¹¶å‘æ€§ï¼šä¸€ä¸ªçº¿ç¨‹åœ¨é‡Šæ”¾å†…å­˜æ—¶ï¼Œå¦ä¸€ä¸ªå¯ä»¥åˆ†é…æ–°block
3. é¿å…æ­»é”ï¼š é”çš„ç²’åº¦æ›´ç»†

### 5.2 åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼
```CPP
if(free_list_ != nullptr){  // ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼ˆæ— é”ï¼‰
    {
        std::lock_guard<std::mutex> lock(mutex_for_free_list_);
        if(free_list_ != nullptr){  // ç¬¬äºŒæ¬¡æ£€æŸ¥ï¼ˆæœ‰é”ï¼‰
            // å®é™…æ“ä½œ
        }
    }
}
```
**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ**

1. é¿å…ä¸å¿…è¦çš„åŠ é”å¼€é”€
2. åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ˜¾è‘—æå‡æ€§èƒ½





## é¡¹ç›®ï¼šåŸºäºå“ˆå¸Œæ˜ å°„çš„å¤šç§å®šé•¿å†…å­˜åˆ†é…å™¨
![](https://cdn.nlark.com/yuque/0/2024/jpeg/39027506/1732612548134-15b20832-d60d-4cdc-8990-cc508ad4a1c7.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_25%2Ctext_5Luj56CB6ZqP5oOz5b2V55-l6K-G5pif55CD%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)


![](https://cdn.nlark.com/yuque/0/2024/jpeg/39027506/1732623935791-c3136b91-afc4-4e2a-9838-4c7f6056dbdb.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_34%2Ctext_5Luj56CB6ZqP5oOz5b2V55-l6K-G5pif55CD%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

é€šè¿‡hashbucketå¯ä»¥æ‰¾åˆ°å­˜å‚¨ä¸åŒå¤§å°æ•°æ®çš„å†…å­˜æ± ï¼Œä¸€å…±è®¾è®¡äº†ä»8ï½512ä¸€å…±64ç§ç±»å‹çš„å†…å­˜æ± ã€‚ä¸è¿‡ï¼Œæ¯ä¸ªpoolè‡ªèº«çš„sizeæ˜¯ä¸€è‡´çš„ã€‚   
ä½†æ˜¯å¹¶ä¸æ˜¯OSç›´æ¥ä¸ºpooläº‹å…ˆåˆ†é…å¥½å›ºå®šå†…å­˜ï¼Œè€Œæ˜¯éœ€è¦çš„æ—¶å€™æ‰åˆ†é…ï¼Œé‡Šæ”¾å¯¹è±¡åä¸è¢«oså›æ”¶ï¼Œè€Œæ˜¯åŠ å…¥åˆ°freeslot é“¾è¡¨ï¼Œä¸‹ä¸€ä¸ªå¯¹è±¡å°±ä¸éœ€è¦è°ƒç”¨new åˆ†é…äº†ã€‚

1. MemoryPool å’Œ HashBucket ä¸å…³å¿ƒç±»å‹ï¼Œåªå…³å¿ƒå¤§å°ã€‚åœ¨newElementå’ŒdeleteElementå¤„æ˜¯æ¨¡æ¿å‡½æ•°ï¼Œä¼šä¼ å…¥ç±»å‹ã€‚   
2. å†…å­˜å¯¹é½çš„æ„ä¹‰ï¼š   
    + æé«˜è®¿é—®æ•ˆç‡ï¼šcpuç¼“å­˜ä¸€èˆ¬æ˜¯å›ºå®šå¤§å°çš„blockï¼ˆ64ï¼Œ128ï¼‰ï¼Œæ•°æ®å¯¹é½åˆ™å¯ä»¥å®Œå…¨æ”¾å…¥ç¼“å†²blockï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡
    + ä¿è¯å…¼å®¹æ€§ï¼š C++æ ‡å‡†åº“çš„æ•°æ®ç»“æ„é€šå¸¸è¦æ±‚å¯¹é½ï¼Œä¾‹å¦‚std::allocatoråˆ†é…çš„å†…å­˜é»˜è®¤æŒ‰æœ€å¤§å¯¹é½è¦æ±‚å¯¹é½ã€‚å¯¹é½å†…å­˜å¯ä»¥ç¡®ä¿ä»£ç åœ¨ä¸åŒæ¶æ„ä¸‹æ­£ç¡®è¿è¡Œï¼Œé¿å…æ½œåœ¨é—®é¢˜ã€‚

